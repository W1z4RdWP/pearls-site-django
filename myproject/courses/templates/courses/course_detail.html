{% extends 'layout.html' %}
{% load static %}
{% block content %}

<div class="container mt-4">
    <h1>{{ course.title }}</h1>
    <p class="lead">{{ course.description|safe }}</p>
    <hr>
    <span>
        <p class="lead">–ê–≤—Ç–æ—Ä –∫—É—Ä—Å–∞: {{ course_author }}</p>
        <p>{{ course.author.email }}</p>
    </span>
    <hr>
    {% if has_started %}
    <div class="progress mb-4">
        <div class="progress-bar" role="progressbar" 
             style="width: {{ progress }}%" 
             aria-valuenow="{{ progress }}" 
             aria-valuemin="0" 
             aria-valuemax="100">
            {{ completed_lessons }}/{{ total_lessons }} ({{ progress }}%)
        </div>
    </div>
    {% endif %}
    
    
    <div class="row">
        <div class="col-md-8">
            <h3>–£—Ä–æ–∫–∏ –∫—É—Ä—Å–∞</h3>
            <div class="list-group">
                {% for lesson in lessons %}  {# –ò—Å–ø–æ–ª—å–∑—É–µ–º lessons, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∏–∑ view #}
                <a href="{% url 'lesson_detail' course.slug lesson.id %}" 
                   class="list-group-item list-group-item-action">
                    {{ lesson.title }}
                    {% if has_started and lesson.id in completed_lessons_ids %}
                        <span class="badge bg-success float-end">‚úì</span>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>


        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    {% if request.user.is_authenticated and has_started %}
                    <p class="text-success">–í—ã –Ω–∞—á–∞–ª–∏ —ç—Ç–æ—Ç –∫—É—Ä—Å {{ user_course.start_date|date:"d.m.Y" }}</p>
                    {% if all_completed and user_course.end_date %}
                        {% if not show_final_quiz %}
                                <div class="alert alert-info">
                                    –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫—É—Ä—Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–π—Ç–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç
                                    <a href="{% url 'quiz_start' quiz_id=course.final_quiz.id %}" class="btn btn-primary">
                                    –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</a>
                                </div>
                        {% else %}
                            <p class="text-success">–ö—É—Ä—Å –∑–∞–≤–µ—Ä—à–µ–Ω: {{ user_course.end_date|date:"d.m.Y" }}</p>
                        {% endif %}
                    {% endif %}
                        {% if next_lesson.id %}
                            <a href="{% url 'lesson_detail' course.slug next_lesson.id %}" 
                            class="btn btn-primary w-100">
                                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ
                            </a>
                    
                        {% endif %}
                    {% else %}
                    <form method="POST">
                        {% csrf_token %}
                        {% comment %} <button type="submit" name="start_course" 
                                class="btn btn-success w-100">
                            –ù–∞—á–∞—Ç—å –∫—É—Ä—Å
                        </button> {% endcomment %}
                        <img src="{% if course.image %}{{ course.image.url }}{% else %}{% static 'imgs/default.jpg' %}{% endif %}" alt="Course Image" id="course_detail_img">
                    </form>
                    {% endif %}
                </div>
                {% if user.is_authenticated and user.is_staff %}
                <div class="course-actions">
                    <a href="{% url 'create_lesson' course.slug %}" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</a>
                    <a href="{% url 'edit_course' course.slug %}" class="btn btn-warning">
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </a>
                    <form method="POST" action="{% url 'delete_course' course.slug %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" 
                                onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—É—Ä—Å? –í—Å–µ —É—Ä–æ–∫–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')">
                            –£–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å
                        </button>
                    </form>
                </div>
            {% endif %}
            </div>
        </div>
    </div>
    {% if all_completed %}
        <div id="course-completion-animation" class="completion-animation">
            <div class="confetti"></div>
            <div class="completion-message">
                <h2>üéâ –ö—É—Ä—Å –∑–∞–≤–µ—Ä—à–µ–Ω! üéâ</h2>
                <p>–í—ã –ø–æ–ª—É—á–∏–ª–∏ <span>{{ exp_earned }}</span> –æ–ø—ã—Ç–∞!</p>
            </div>
        </div>
    {% endif %}
</div>
        
<div class="feedback-block mt-5">
    {% if not request.user.username == course_author %}
        <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        {% if has_started %}
        <form method="POST" class="mb-4">
            {% csrf_token %}
            <textarea name="message" class="form-control" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required></textarea>
            <button type="submit" name="send_message" class="btn btn-primary mt-2">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            </button>
        </form>
        {% endif %}
        <h4>–û–±—â–µ–Ω–∏–µ —Å –∫—É—Ä–∞—Ç–æ—Ä–æ–º</h4>
    {% else %}
        <h4>–û–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏</h4>
    {% endif %}
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ -->
    <div class="message-history">
        {% for msg in course_messages %}
        <div class="card mb-3 {% if msg.recipient == request.user and not msg.is_read %}border-primary{% endif %}">
            <div class="card-body">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center gap-2">

                        <div>
                            <strong>
                                {% if msg.sender == request.user %}
                                    <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                                    <img class="message-avatar" 
                                    src="{{ msg.sender.profile.image.url|default:'https://via.placeholder.com/150' }}" 
                                    alt="{{ msg.sender.username }}" 
                                    style="width: 32px; height: 32px; object-fit: cover;">
                                    –í—ã ‚Üí {{ msg.recipient.get_full_name|default:msg.recipient.username }}
                                     <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è -->
                                    <img class="rounded-circle" 
                                    src="{{ msg.recipient.profile.image.url|default:'https://via.placeholder.com/150' }}" 
                                    alt="{{ msg.recipient.username }}" 
                                    style="width: 32px; height: 32px; object-fit: cover;">
                                {% else %}
                                    <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                                    <img class="message-avatar" 
                                    src="{{ msg.sender.profile.image.url|default:'https://via.placeholder.com/150' }}" 
                                    alt="{{ msg.sender.username }}" 
                                    style="width: 32px; height: 32px; object-fit: cover;">
                                    {{ msg.sender.get_full_name|default:msg.sender.username }} ‚Üí –í–∞–º                             
                                    <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è -->
                                    <img class="message-avatar" 
                                        src="{{ msg.recipient.profile.image.url|default:'https://via.placeholder.com/150' }}" 
                                        alt="{{ msg.recipient.username }}" 
                                        style="width: 32px; height: 32px; object-fit: cover;">
                                {% endif %}
                            </strong>
                            <small class="text-muted ms-2">{{ msg.timestamp|date:"d.m.Y H:i" }}</small>
                        </div>
                    </div>
                    
                    {% if msg.recipient == request.user and not msg.is_read %}
                        <span class="badge bg-primary">–ù–æ–≤–æ–µ</span>
                    {% endif %}
                </div>

                <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <p class="mb-0">{{ msg.message }}</p>

                <!-- –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ -->
                {% if msg.recipient == request.user %}
                <form method="POST" class="mt-3">
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="{{ msg.id }}">
                    <textarea name="message" class="form-control" rows="2" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." required></textarea>
                    <button type="submit" name="send_message" class="btn btn-sm btn-outline-primary mt-2">
                        –û—Ç–≤–µ—Ç–∏—Ç—å
                    </button>
                </form>
                {% endif %}

                <!-- –û—Ç–≤–µ—Ç—ã -->
                {% for reply in msg.get_replies %}
                <div class="ms-4 mt-3 border-start ps-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                {% if reply.sender == request.user %}
                                    –í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏:
                                {% else %}
                                    {{ reply.sender.username }} –æ—Ç–≤–µ—Ç–∏–ª:
                                {% endif %}
                                <span>{{ reply.timestamp|date:"d.m.Y H:i" }}</span>
                            </small>
                            <p class="mt-1">{{ reply.message }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {% empty %}
            <div class="alert alert-info">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>
        {% endfor %}
    </div>
</div>
{% endblock %}